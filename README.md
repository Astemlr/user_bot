# Telegram News Aggregator Bot

Telegram-бот для агрегации новостей с фильтрацией по ключевым словам и семантическому поиску. Система позволяет пользователям подписываться на каналы и группы, настраивать фильтры и получать отфильтрованные сообщения в указанный чат.

## Архитектура

Система состоит из двух компонентов:

1. **User Bot** (Pyrogram Client API) - мониторит сообщения из подписанных каналов/чатов, применяет фильтры и пересылает соответствующие сообщения в целевой чат пользователя.

2. **Classic Bot** (Pyrogram Bot API) - предоставляет интерфейс для управления фильтрами и подписками через команды Telegram.

### Схема работы

```
User Bot → Мониторинг сообщений → Фильтрация → Пересылка в target_chat
                ↑
                |
         Подписки из БД
                ↑
         Classic Bot ← Управление через команды
```

### Ручная установка

1. Создайте виртуальное окружение:

```bash
python3 -m venv venv
source venv/bin/activate 

2. Установите зависимости:

```bash
pip install -r requirements.txt
```

3. Создайте и заполните `.env` 

4. Убедитесь, что PostgreSQL запущен

5. Инициализируйте базу данных:

```bash
python init_db.py
```

6. Запустите бота:

```bash
python main.py
```

### Настройка базы данных

`DATABASE_URL` должен указывать на существующую БД или БД будет создана автоматически при запуске `init_db.py`. Формат:

```
postgresql+asyncpg://username:password@host:port/database_name
```

Пример:

```
postgresql+asyncpg://postgres:password@localhost:5432/news_bot
```

### Настройка семантического поиска

- `SEMANTIC_MODEL` - модель для семантического поиска. Рекомендуемые модели для русского языка:
  - `ai-forever/sbert_large_nlu_ru` - самая точная (~700MB)
  - `cointegrated/rubert-base` - хорошая точность, средний размер
  - `cointegrated/rubert-tiny2` - быстрая, но менее точная

- `SEMANTIC_THRESHOLD` - порог схожести (0.0 - 1.0). Чем выше, тем строже фильтрация:
  - 0.25-0.35 - мягкая фильтрация (распознает синонимы и контекст)
  - 0.5-0.6 - средняя фильтрация (баланс точности и покрытия)
  - 0.7-0.75 - строгая фильтрация (только точные совпадения)

## Использование

### Первый запуск

При первом запуске User Bot потребует авторизацию:
1. Введите номер телефона
2. Введите код подтверждения из Telegram
3. При необходимости введите пароль двухфакторной аутентификации

После авторизации сессия сохранится в файле `user_bot_session.session`.

### Команды Classic Bot

#### Базовые команды

- `/start` - приветствие и инструкция
- `/help` - справка по всем командам

#### Управление фильтрами

- `/add_filter <ключевые слова через запятую>` - добавить фильтр по ключевым словам
  - Пример: `/add_filter python, программирование, разработка`
  
- `/add_topic <тема>` - добавить тему для семантического поиска
  - Пример: `/add_topic искусственный интеллект`
  
- `/list_filters` - показать все ваши фильтры
  
- `/delete_filter <id>` - удалить фильтр по ID

#### Управление подписками

- `/add_subscription <username или ID>` - подписаться на канал/чат
  - Пример: `/add_subscription @channel_name` или `/add_subscription -1001234567890`
  
- `/list_subscriptions` - показать все подписки
  
- `/remove_subscription <id>` - отписаться от канала/чата

#### Настройки

- `/set_target_chat` - установить целевой чат для пересылки сообщений
  - Используйте команду в нужном чате или ответьте на сообщение в нужном чате
  - Можно указать ID чата: `/set_target_chat -1001234567890`

### Процесс работы

1. **Настройка фильтров**: Используйте `/add_filter` или `/add_topic` для создания фильтров
2. **Добавление подписок**: Используйте `/add_subscription` для подписки на каналы/чаты
3. **Установка целевого чата**: Используйте `/set_target_chat` в чате, куда хотите получать отфильтрованные сообщения
4. **Мониторинг**: User Bot автоматически мониторит все подписанные каналы/чаты
5. **Фильтрация**: Сообщения, соответствующие фильтрам, автоматически пересылаются в целевой чат

## Технические детали

### Фильтрация

Система поддерживает два типа фильтров:

1. **Поиск по ключевым словам**: Простой поиск подстроки в тексте (регистронезависимый). Сообщение пересылается, если содержит хотя бы одно из указанных ключевых слов.

2. **Семантический поиск**: Использует модель `sentence-transformers` для вычисления семантического сходства между текстом сообщения и заданными темами. Система использует адаптивные пороги в зависимости от длины текста:
   - 1 слово: порог 0.85 (для точных совпадений)
   - 2 слова: порог 0.35 (для синонимов)
   - 3 слова: порог 0.35 (для контекстных формулировок)
   - 4+ слов: порог из конфига (обычно 0.25)

Для повышения точности используется двухуровневая система фильтрации:
- Высокая схожесть (>0.50) - проверка на ложные срабатывания
- Средняя схожесть (0.35-0.50) - проверка общих слов и синонимов
- Низкая схожесть (<0.35) - только при наличии ключевых слов

### База данных

Используется PostgreSQL с тремя основными таблицами:

- `users` - пользователи бота (user_id, username, target_chat_id)
- `filters` - фильтры пользователей (keywords, topics, use_semantic)
- `subscriptions` - подписки на каналы/чаты (chat_id, chat_title, chat_type)

### Multi-user поддержка

Каждый пользователь имеет:
- Свои фильтры (ключевые слова и темы)
- Свои подписки на каналы/чаты
- Свой целевой чат для пересылки

### Обработка ошибок

Система обрабатывает следующие ошибки Telegram API:
- `FloodWait` - автоматическое ожидание указанного времени
- `PeerFlood` - логирование ограничения, предотвращение спама
- Rate limiting - минимальный интервал между пересылками (2 секунды)

## Важные замечания

1. User Bot требует авторизации через телефон при первом запуске. Сессия сохраняется в файле `user_bot_session.session`.

2. Семантическая модель загружается при первом использовании (может занять время, особенно для больших моделей).

3. Для работы с каналами User Bot должен быть участником этих каналов. Добавьте аккаунт, с которого получены API credentials, в нужные группы/каналы.

4. Целевой чат по умолчанию - личные сообщения пользователя, если не установлен другой через `/set_target_chat`.

5. User Bot мониторит только группы и каналы (не личные чаты). Сообщения от ботов также игнорируются.

6. Classic Bot и User Bot могут использовать разные аккаунты. Classic Bot использует Bot Token, User Bot использует API credentials.

## Получение ID группы/канала

Для добавления подписки через ID необходимо знать числовой ID группы/канала:

1. Добавьте аккаунт (User Bot) в группу/канал
2. Используйте команду `/add_subscription` с числовым ID (например: `/add_subscription -1001234567890`)
3. Или используйте @username, если он есть у группы/канала

ID групп обычно отрицательные (например: -1001234567890), ID каналов могут быть как отрицательными, так и положительными.

## Производительность

- Семантическая модель загружается один раз при первом использовании
- Фильтрация выполняется асинхронно
- Rate limiting предотвращает превышение лимитов Telegram API
- Поддержка множественных пользователей без конфликтов

## Лицензия

Проект создан в учебных целях.
